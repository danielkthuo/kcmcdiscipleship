<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session 3: Narrative Theology for the Family</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Firebase imports -->
    <script type="module" src="../auth-check.js"></script>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="KCM Church">
    <meta name="description" content="Discipleship Tool for Kingdom Covenant Ministries Church">
    <meta name="keywords" content="church, discipleship, christian, ministry">
    <meta name="author" content="Kingdom Covenant Ministries Church">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-startup-image" href="icons/icon-512x512.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Viewport for mobile optimization -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- Preload important resources -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com/ajax.googleapis.com">
    
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            font-family: var(--font-main);
            background: #f9f9f9;
            color: #333;
            scroll-behavior: smooth;
            line-height: 1.6;
        }

        /* ===== HEADER ===== */
        header {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            position: relative;
            box-shadow: var(--shadow);
        }

        header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        header .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.5s ease;
        }

        /* ===== MAIN CONTENT ===== */
        .container {
            width: 100%;
            padding: 0 1rem 100px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--secondary);
            color: white;
            padding: 14px 20px;
            border-radius: var(--radius);
            border: none;
            font-weight: 600;
            text-decoration: none;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s;
            cursor: pointer;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }

        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }

        /* ===== NAVIGATION ===== */
        .lesson-nav {
            display: flex;
            gap: 10px;
            margin: 1.5rem 0;
        }

        /* ===== COLLAPSIBLE SECTIONS ===== */
        .collapsible-section {
            margin-bottom: 1rem;
            width: 100%;
        }

        .collapsible-header {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            text-align: left;
            padding: 1.2rem 1.5rem;
            font-weight: 600;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            font-size: 1.1rem;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .collapsible-header i {
            transition: transform 0.3s ease;
        }

        .collapsible-header.active i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            background: white;
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .collapsible-content.active {
            max-height: 500px;
            overflow-y: auto;
        }

        .content-inner {
            padding: 1.5rem;
        }

        /* ===== ENHANCED CONTENT STYLES ===== */
        .content-section {
            margin-bottom: 2rem;
        }

        .content-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
            font-size: 1.3rem;
        }

        .scripture {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-left: 6px solid var(--secondary);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 var(--radius) var(--radius) 0;
            font-style: italic;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .scripture:before {
            content: "üìñ";
            position: absolute;
            left: -35px;
            top: 15px;
            font-size: 1.2rem;
            background: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .key-point {
            background: linear-gradient(to right, #e8f4fc, #d4edfc);
            border-left: 6px solid var(--success);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 var(--radius) var(--radius) 0;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .key-point:before {
            content: "üí°";
            position: absolute;
            left: -35px;
            top: 15px;
            font-size: 1.2rem;
            background: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .reflection {
            background: linear-gradient(to right, #f0f7ff, #e1f0ff);
            border-left: 6px solid #9b59b6;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 var(--radius) var(--radius) 0;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .reflection:before {
            content: "‚úçÔ∏è";
            position: absolute;
            left: -35px;
            top: 15px;
            font-size: 1.2rem;
            background: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .reflection textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .reflection textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* ===== ILLUSTRATIONS ===== */
        .illustration {
            width: 100%;
            margin: 1.5rem 0;
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .narrative-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 1.5rem 0;
        }

        .narrative-stage {
            width: 100%;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
        }

        .narrative-stage h4 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stage-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .stage-1 { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .stage-2 { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stage-3 { background: linear-gradient(135deg, #3498db, #2980b9); }
        .stage-4 { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 10px 0;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            color: #666;
            text-decoration: none;
            font-size: 0.8rem;
            padding: 5px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item.active {
            color: var(--secondary);
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        /* ===== FOOTER ===== */
        footer {
            width: 100%;
            background: var(--dark);
            color: white;
            text-align: center;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        /* ===== PROGRESS INDICATOR ===== */
        .sync-status {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sync-status.syncing {
            color: var(--warning);
        }

        .sync-status.synced {
            color: var(--success);
        }

        .sync-status.local {
            color: var(--secondary);
        }

        .sync-status.offline {
            color: #666;
        }

        /* ===== COMPLETION INDICATOR ===== */
        .completion-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 1rem;
            padding: 10px;
            background: #f8f9fa;
            border-radius: var(--radius);
        }

        .completion-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .completion-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* ===== NEW: BACK TO TOP BUTTON ===== */
        .back-to-top {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }
        .back-to-top.visible {
            opacity: 1;
        }
        .back-to-top:hover {
            transform: translateY(-3px);
            background: var(--primary);
        }

        /* ===== NEW: DARK MODE TOGGLE ===== */
        .dark-mode-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 998;
        }

        /* ===== NEW: QUICK NAVIGATION ===== */
        .quick-nav {
            position: fixed;
            top: 80px;
            left: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 10px;
            z-index: 997;
            display: none;
        }
        .quick-nav.active {
            display: block;
        }
        .quick-nav-item {
            display: block;
            padding: 8px 12px;
            color: var(--primary);
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 5px;
            transition: background 0.3s;
        }
        .quick-nav-item:hover {
            background: #f0f7ff;
        }
        .quick-nav-toggle {
            position: fixed;
            top: 80px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 998;
        }

        /* ===== NEW: NOTE-TAKING FUNCTIONALITY ===== */
        .note-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #ddd;
        }
        .note-input {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-family: inherit;
            resize: vertical;
            margin-bottom: 10px;
        }
        .note-save {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
        }
        .saved-notes {
            margin-top: 1rem;
        }
        .saved-note {
            background: #f9f9f9;
            padding: 10px;
            border-radius: var(--radius);
            margin-bottom: 10px;
            border-left: 3px solid var(--secondary);
        }
        .note-date {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        /* ===== NEW: DARK MODE STYLES ===== */
        body.dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        body.dark-mode .collapsible-content {
            background: #2d2d2d;
        }
        body.dark-mode .content-inner {
            background: #2d2d2d;
        }
        body.dark-mode .scripture {
            background: linear-gradient(to right, #2d2d2d, #3d3d3d);
        }
        body.dark-mode .key-point {
            background: linear-gradient(to right, #2d3d4d, #3d4d5d);
        }
        body.dark-mode .reflection {
            background: linear-gradient(to right, #2d2d4d, #3d3d5d);
        }
        body.dark-mode .reflection textarea {
            background: #3d3d3d;
            color: #e0e0e0;
            border-color: #555;
        }
        body.dark-mode .illustration {
            background: #2d2d2d;
        }
        body.dark-mode .completion-indicator {
            background: #3d3d3d;
        }
        body.dark-mode .bottom-nav {
            background: #2d2d2d;
        }
        body.dark-mode .nav-item {
            color: #b0b0b0;
        }
        body.dark-mode .nav-item.active {
            color: var(--secondary);
            background: #3d4d5d;
        }
        body.dark-mode .saved-note {
            background: #3d3d3d;
        }
        body.dark-mode .note-input {
            background: #3d3d3d;
            color: #e0e0e0;
            border-color: #555;
        }
        body.dark-mode .quick-nav {
            background: #2d2d2d;
        }
        body.dark-mode .quick-nav-item {
            color: #e0e0e0;
        }
        body.dark-mode .quick-nav-item:hover {
            background: #3d4d5d;
        }
        body.dark-mode .narrative-stage {
            background: #2d2d2d;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.3rem;
            }
            
            header .subtitle {
                font-size: 0.9rem;
            }
            
            .collapsible-header {
                padding: 1rem;
                font-size: 1rem;
            }
            
            .content-inner {
                padding: 1rem;
            }
            
            .lesson-nav {
                flex-direction: column;
            }
            
            .scripture:before, .key-point:before, .reflection:before {
                left: -25px;
                width: 20px;
                height: 20px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 0.5rem 100px;
            }
            
            .collapsible-header {
                padding: 0.8rem;
                font-size: 0.95rem;
            }
            
            .content-inner {
                padding: 0.8rem;
            }
            
            .reflection textarea {
                min-height: 100px;
            }
        }

        /* ===== SCROLLBAR STYLING ===== */
        .collapsible-content::-webkit-scrollbar {
            width: 8px;
        }

        .collapsible-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .collapsible-content::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        .collapsible-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <!-- NEW: Dark mode toggle -->
    <div class="dark-mode-toggle" id="darkModeToggle">
        <i class="fas fa-moon"></i>
    </div>
    
    <!-- NEW: Quick navigation toggle -->
    <div class="quick-nav-toggle" id="quickNavToggle">
        <i class="fas fa-bars"></i>
    </div>
    
    <!-- NEW: Quick navigation menu -->
    <div class="quick-nav" id="quickNav">
        <a href="#key-verse" class="quick-nav-item">Key Verse & Introduction</a>
        <a href="#four-act-play" class="quick-nav-item">The Four-Act Play</a>
        <a href="#couples-reflection" class="quick-nav-item">Guided Couple's Reflection</a>
    </div>
    
    <!-- Header Section -->
    <header>
        <h1>SESSION 3: NARRATIVE THEOLOGY FOR THE FAMILY</h1>
        <p class="subtitle">Weaving Our Story Into God's Story</p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="sync-status" id="syncStatus">
            <i class="fas fa-check-circle"></i>
            <span>Synced</span>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Navigation -->
        <div class="lesson-nav">
            <a href="session2.html" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i>
                Previous Session
            </a>
            <a href="session4.html" class="btn">
                Next Session
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>

        <!-- Collapsible Section 1 -->
        <div class="collapsible-section">
            <button class="collapsible-header" id="header1">
                <span>Key Verse & Introduction</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapsible-content" id="content1">
                <div class="content-inner">
                    <div class="content-section" id="key-verse">
                        <h3>Theme</h3>
                        <p>Acknowledging that discipleship is putting our child's individual narrative into the larger metanarrative of Scripture.</p>
                        
                        <div class="scripture">
                            <p><strong>Psalm 78:4 NKJV</strong> - "We will not hide them from their children, telling to the generation to come the praises of the Lord, And His strength and His wonderful works that He has done."</p>
                        </div>
                        
                        <div class="key-point">
                            <p><strong>Understanding Narrative Theology:</strong> Our lives are not random sets of events but are part of a divine drama. As parents, we have the privilege and responsibility to help our children understand how their personal stories fit into God's grand story of creation, fall, redemption, and restoration.</p>
                        </div>
                        
                        <!-- NEW: Note-taking section -->
                        <div class="note-section">
                            <h4>Personal Notes</h4>
                            <textarea class="note-input" placeholder="Add your personal notes about narrative theology..." data-note-id="narrative-intro"></textarea>
                            <button class="note-save" data-note-id="narrative-intro">Save Note</button>
                            <div class="saved-notes" id="narrative-intro-notes"></div>
                        </div>
                    </div>
                    
                    <div class="completion-indicator">
                        <div class="completion-checkbox" id="completion1">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Mark as complete</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collapsible Section 2 -->
        <div class="collapsible-section">
            <button class="collapsible-header" id="header2">
                <span>The Four-Act Play</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapsible-content" id="content2">
                <div class="content-inner">
                    <div class="content-section" id="four-act-play">
                        <h3>The Divine Drama</h3>
                        <p>Our lives are part of a four-act divine drama that gives meaning and purpose to our existence. Understanding this framework helps us parent with eternal perspective.</p>
                        
                        <div class="narrative-container">
                            <div class="narrative-stage stage-1">
                                <h4>
                                    <span class="stage-icon">1</span>
                                    Creation - Wonderfully Made in God's Image
                                </h4>
                                <p>The child is fearfully and wonderfully made, bearing the image of God.</p>
                                
                                <div class="scripture">
                                    <p><strong>Psalm 139:14</strong> - "I praise you because I am fearfully and wonderfully made."</p>
                                </div>
                                
                                <div class="key-point">
                                    <p><strong>Parenting Application:</strong> Each child is initially a beautiful reflection of God's creative heart. They have the Imago Dei ‚Äì with which comes worth, dignity, and purpose. As parents, we are gifted with the responsibility of nurturing that truth from the earliest of years by:</p>
                                    <ul>
                                        <li>Affirming their individuality and gifts from God</li>
                                        <li>Inviting wonder, creativity, and thanksgiving for creation</li>
                                        <li>Helping them understand that their bodies, minds, and abilities are good gifts according to God</li>
                                    </ul>
                                </div>
                                
                                <!-- NEW: Note-taking section -->
                                <div class="note-section">
                                    <h4>Personal Notes - Creation</h4>
                                    <textarea class="note-input" placeholder="Add your personal notes about creation..." data-note-id="creation-stage"></textarea>
                                    <button class="note-save" data-note-id="creation-stage">Save Note</button>
                                    <div class="saved-notes" id="creation-stage-notes"></div>
                                </div>
                            </div>
                            
                            <div class="narrative-stage stage-2">
                                <h4>
                                    <span class="stage-icon">2</span>
                                    Fall ‚Äî Living in a Broken World
                                </h4>
                                <p>Although all children are made in the image of God, each of them lives in a world broken by sin.</p>
                                
                                <div class="scripture">
                                    <p><strong>Romans 3:23</strong> - "For all have sinned and fall short of the glory of God."</p>
                                </div>
                                
                                <div class="key-point">
                                    <p><strong>Parenting Application:</strong> Even with the best of intentions, parents and children hurt, disobey, or make mistakes. Understanding the Fall allows parents to:</p>
                                    <ul>
                                        <li>Teach honesty and repentance without shame</li>
                                        <li>Help children name their feelings when they struggle</li>
                                        <li>Model forgiveness and humility when parents themselves fall short</li>
                                    </ul>
                                </div>
                                
                                <!-- NEW: Note-taking section -->
                                <div class="note-section">
                                    <h4>Personal Notes - Fall</h4>
                                    <textarea class="note-input" placeholder="Add your personal notes about the Fall..." data-note-id="fall-stage"></textarea>
                                    <button class="note-save" data-note-id="fall-stage">Save Note</button>
                                    <div class="saved-notes" id="fall-stage-notes"></div>
                                </div>
                            </div>
                            
                            <div class="narrative-stage stage-3">
                                <h4>
                                    <span class="stage-icon">3</span>
                                    Redemption - Loved and Saved in Christ
                                </h4>
                                <p>The child is the object of God's saving love in Christ.</p>
                                
                                <div class="scripture">
                                    <p><strong>Romans 5:8</strong> - "While we were still sinners, Christ died for us."</p>
                                </div>
                                
                                <div class="key-point">
                                    <p><strong>Parenting Application:</strong> In Christ, God meets us in our brokenness with redeeming love. Redemption is not just a concept ‚Äî it is a daily reality in a believer's parenting life. Every time we forgive, show compassion, or remind our children that nothing can separate them from the love of God, we are living out redemption. Parents can:</p>
                                    <ul>
                                        <li>Take teachable moments to discuss God's forgiveness and grace</li>
                                        <li>Pray together when mistakes are made, reminding them of Christ's love</li>
                                        <li>Exhibit a love that is unconditional, and points back to the cross</li>
                                    </ul>
                                </div>
                                
                                <!-- NEW: Note-taking section -->
                                <div class="note-section">
                                    <h4>Personal Notes - Redemption</h4>
                                    <textarea class="note-input" placeholder="Add your personal notes about redemption..." data-note-id="redemption-stage"></textarea>
                                    <button class="note-save" data-note-id="redemption-stage">Save Note</button>
                                    <div class="saved-notes" id="redemption-stage-notes"></div>
                                </div>
                            </div>
                            
                            <div class="narrative-stage stage-4">
                                <h4>
                                    <span class="stage-icon">4</span>
                                    Restoration: Called to Participate in God's Work
                                </h4>
                                <p>The child is called to participate in God's work of renewing all things.</p>
                                
                                <div class="key-point">
                                    <p><strong>Parenting Application:</strong> The story God has planned does not conclude with forgiveness; it progresses to renewal. Children who understand they are loved and forgiven become capable of becoming facilitators of restoration - peacemakers, helpers, and light-bringers in the home, at school, and in their communities. Parents can expand this knowledge by:</p>
                                    <ul>
                                        <li>Encouraging actions of kindness, service, and responsibility</li>
                                        <li>Affording children responsibility in the story and to see themselves as part of God's mission</li>
                                        <li>Celebrating occasions when they offered healing or hope to another</li>
                                    </ul>
                                </div>
                                
                                <!-- NEW: Note-taking section -->
                                <div class="note-section">
                                    <h4>Personal Notes - Restoration</h4>
                                    <textarea class="note-input" placeholder="Add your personal notes about restoration..." data-note-id="restoration-stage"></textarea>
                                    <button class="note-save" data-note-id="restoration-stage">Save Note</button>
                                    <div class="saved-notes" id="restoration-stage-notes"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="completion-indicator">
                            <div class="completion-checkbox" id="completion2">
                                <i class="fas fa-check"></i>
                            </div>
                            <span>Mark as complete</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collapsible Section 3 -->
        <div class="collapsible-section">
            <button class="collapsible-header" id="header3">
                <span>Guided Couple's Reflection</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapsible-content" id="content3">
                <div class="content-inner">
                    <div class="content-section" id="couples-reflection">
                        <h3>Parenting the Gospel Story</h3>
                        <p>Parenting is not just about behavior management ‚Äî it is about discipling hearts and helping our kids find their role in God's redemptive story. As a couple, set apart time each week to prayerfully and honestly reflect on how the gospel contributes to your parenting in community.</p>
                        
                        <div class="content-section">
                            <h3>1. Diagnosing the Fall ‚Äî The False Story Behind the Sin</h3>
                            <p>Think of a specific occasion of your child sinning recently. Rather than just focusing on the behavior, talk about, "What false story was our child believing in that moment?" (e.g., "I need to lie to be safe.") In the story of the Fall and ultimate salvation story of the Cross, how can we tell that moment's story differently?</p>
                            
                            <div class="scripture">
                                <p><strong>Jeremiah 17:9</strong> - "The heart is deceitful above all things, and desperately sick; who can know it?"</p>
                            </div>
                            
                            <div class="key-point">
                                <p><strong>Understanding False Stories:</strong> Every sinful behavior in a child's life is based on a false belief ‚Äî a small lie that distorts God's truth. When we slow down to look beyond the behavior (the tantrum, the lie, or the disobedience), we often discover a broader story.</p>
                            </div>
                            
                            <div class="reflection">
                                <p>Describe a recent instance of your child's misbehavior:</p>
                                <textarea placeholder="Describe the situation and behavior..." data-reflection-id="false-story1"></textarea>
                                
                                <p>What false story might your child have been believing in that moment?</p>
                                <textarea placeholder="What false belief might have driven this behavior? (e.g., 'I need to lie to be safe')" data-reflection-id="false-story2"></textarea>
                                
                                <p>How can you retell this story through the lens of the gospel?</p>
                                <textarea placeholder="How can you reframe this with God's truth?" data-reflection-id="false-story3"></textarea>
                            </div>
                        </div>
                        
                        <div class="content-section">
                            <h3>2. The "Redemptive Moment" Plan</h3>
                            <p>Think of a repeated pattern that is problematic. How can you, as a team, get ahead of the game and create a way to "script a redemptive moment"? Let's take sibling rivalry as an example: create a simple family liturgy that says, "In this house, we are not opponents/competitors...we are teammates. We are here to build each other up...because we are on the same team."</p>
                            
                            <div class="key-point">
                                <p><strong>Creating Redemptive Rhythms:</strong> Instead of just reacting to problems, we can proactively create family practices that reinforce gospel truths and reshape our family culture.</p>
                            </div>
                            
                            <div class="reflection">
                                <p>Identify a recurring challenge in your family:</p>
                                <textarea placeholder="Describe the pattern or challenge..." data-reflection-id="redemptive1"></textarea>
                                
                                <p>What gospel truth can counter this pattern?</p>
                                <textarea placeholder="What biblical truth addresses this issue?" data-reflection-id="redemptive2"></textarea>
                                
                                <p>Create a simple "family liturgy" or practice to reinforce this truth:</p>
                                <textarea placeholder="Design a simple phrase, prayer, or practice..." data-reflection-id="redemptive3"></textarea>
                            </div>
                        </div>
                        
                        <div class="completion-indicator">
                            <div class="completion-checkbox" id="completion3">
                                <i class="fas fa-check"></i>
                            </div>
                            <span>Mark as complete</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="lesson-nav">
            <button class="btn btn-outline" id="viewProgress">
                <i class="fas fa-chart-bar"></i>
                View Progress
            </button>
            <button class="btn" id="saveProgress">
                <i class="fas fa-save"></i>
                Save Progress
            </button>
        </div>
        
        <!-- NEW: Back to top button -->
        <div class="back-to-top" id="backToTop">
            <i class="fas fa-arrow-up"></i>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <a href="../progress.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </a>
        <a href="lessons.html" class="nav-item active">
            <i class="fas fa-book nav-icon"></i>
            <span>Lessons</span>
        </a>
        <a href="resources.html" class="nav-item">
            <i class="fas fa-tools nav-icon"></i>
            <span>Resources</span>
        </a>
        <a href="../profile.html" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span>Profile</span>
        </a>
    </div>

    <!-- Footer -->
    <footer>
        <p>Pathlight Discipleship Curriculum &copy; 2023 | KCMC</p>
        <p>Lit to Lead. Rooted to Grow.</p>
    </footer>

    <script>
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set up collapsible sections
            setupCollapsibleSections();
            
            // Set up completion checkboxes
            setupCompletionCheckboxes();
            
            // Set up auto-save
            setupAutoSave();
            
            // Load saved progress
            loadProgress();
            
            // Set up progress buttons
            document.getElementById('viewProgress').addEventListener('click', showProgressSummary);
            document.getElementById('saveProgress').addEventListener('click', saveProgress);
            
            // NEW: Set up back to top button
            setupBackToTop();
            
            // NEW: Set up quick navigation
            setupQuickNavigation();
            
            // NEW: Set up dark mode toggle
            setupDarkMode();
            
            // NEW: Set up note-taking functionality
            setupNoteTaking();
            
            // NEW: Set up online/offline detection
            setupConnectionListener();
        });

        // Collapsible Sections Functionality
        function setupCollapsibleSections() {
            const headers = document.querySelectorAll('.collapsible-header');
            
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const isActive = this.classList.contains('active');
                    
                    // Close all sections first
                    document.querySelectorAll('.collapsible-header').forEach(h => {
                        h.classList.remove('active');
                    });
                    document.querySelectorAll('.collapsible-content').forEach(c => {
                        c.classList.remove('active');
                        c.style.maxHeight = null;
                    });
                    
                    // If this section wasn't active, open it
                    if (!isActive) {
                        this.classList.add('active');
                        content.classList.add('active');
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                    
                    // Update progress bar
                    updateProgressBar();
                    // Auto-save progress
                    saveProgress();
                });
            });
            
            // Open first section by default
            if (headers.length > 0) {
                headers[0].click();
            }
        }

        // Completion Checkboxes Functionality
        function setupCompletionCheckboxes() {
            const checkboxes = document.querySelectorAll('.completion-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('click', function() {
                    this.classList.toggle('checked');
                    updateProgressBar();
                    // Auto-save progress
                    saveProgress();
                });
            });
        }

        // NEW: Back to top functionality
        function setupBackToTop() {
            const backToTopBtn = document.getElementById('backToTop');
            
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            });
            
            backToTopBtn.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }

        // NEW: Quick navigation functionality
        function setupQuickNavigation() {
            const quickNavToggle = document.getElementById('quickNavToggle');
            const quickNav = document.getElementById('quickNav');
            
            quickNavToggle.addEventListener('click', function() {
                quickNav.classList.toggle('active');
            });
            
            // Close quick nav when clicking outside
            document.addEventListener('click', function(event) {
                if (!quickNav.contains(event.target) && !quickNavToggle.contains(event.target)) {
                    quickNav.classList.remove('active');
                }
            });
        }

        // NEW: Dark mode functionality
        function setupDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const darkModeIcon = darkModeToggle.querySelector('i');
            
            // Check for saved theme preference or respect OS preference
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            const currentTheme = localStorage.getItem('theme');
            
            if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
                document.body.classList.add('dark-mode');
                darkModeIcon.className = 'fas fa-sun';
            }
            
            darkModeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                
                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('theme', 'dark');
                    darkModeIcon.className = 'fas fa-sun';
                } else {
                    localStorage.setItem('theme', 'light');
                    darkModeIcon.className = 'fas fa-moon';
                }
            });
        }

        // NEW: Note-taking functionality
        function setupNoteTaking() {
            // Set up note save buttons
            document.querySelectorAll('.note-save').forEach(button => {
                button.addEventListener('click', function() {
                    const noteId = this.getAttribute('data-note-id');
                    const noteInput = document.querySelector(`.note-input[data-note-id="${noteId}"]`);
                    const savedNotesContainer = document.getElementById(`${noteId}-notes`);
                    
                    if (noteInput.value.trim() !== '') {
                        saveNote(noteId, noteInput.value);
                        noteInput.value = '';
                        loadNotes(noteId, savedNotesContainer);
                        showNotification('Note saved successfully', 'success');
                    }
                });
            });
            
            // Load all saved notes on page load
            document.querySelectorAll('.saved-notes').forEach(container => {
                const noteId = container.id.replace('-notes', '');
                loadNotes(noteId, container);
            });
        }

        function saveNote(noteId, content) {
            const notes = JSON.parse(localStorage.getItem('session3Notes') || '{}');
            
            if (!notes[noteId]) {
                notes[noteId] = [];
            }
            
            notes[noteId].push({
                content: content,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('session3Notes', JSON.stringify(notes));
            
            // Also save to cloud if user is logged in
            if (window.saveProgressToCloud && localStorage.getItem("isLoggedIn") === "true") {
                const sessionData = {
                    session3Notes: notes
                };
                window.saveProgressToCloud(sessionData);
            }
        }

        function loadNotes(noteId, container) {
            const notes = JSON.parse(localStorage.getItem('session3Notes') || '{}');
            const noteArray = notes[noteId] || [];
            
            container.innerHTML = '';
            
            if (noteArray.length === 0) {
                container.innerHTML = '<p class="note-date">No notes yet</p>';
                return;
            }
            
            // Display notes in reverse chronological order (newest first)
            noteArray.reverse().forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'saved-note';
                noteElement.innerHTML = `
                    <div class="note-date">${new Date(note.date).toLocaleString()}</div>
                    <div>${note.content}</div>
                `;
                container.appendChild(noteElement);
            });
        }

        // Progress Bar Update
        function updateProgressBar() {
            const checkboxes = document.querySelectorAll('.completion-checkbox');
            const checked = document.querySelectorAll('.completion-checkbox.checked');
            const progress = (checked.length / checkboxes.length) * 100;
            
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // Auto-save Functionality
        function setupAutoSave() {
            // Auto-save every 30 seconds
            setInterval(saveProgress, 30000);
            
            // Save when leaving page
            window.addEventListener('beforeunload', saveProgress);
        }

        // NEW: Connection listener for online/offline status
        function setupConnectionListener() {
            window.addEventListener('online', function() {
                console.log("üåê Online - syncing data...");
                showNotification('Back online - syncing data', 'success');
                // Auto-save when coming back online
                saveProgress();
            });

            window.addEventListener('offline', function() {
                console.log("üì¥ Offline - saving locally only");
                showNotification('You are offline - saving locally', 'warning');
            });
        }

        // ENHANCED: Save Progress to Local Storage AND Cloud
        async function saveProgress() {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.innerHTML = '<i class="fas fa-sync-alt"></i><span>Syncing...</span>';
            syncStatus.className = 'sync-status syncing';
            
            // Collect completion status
            const completionStatus = {};
            document.querySelectorAll('.completion-checkbox').forEach((checkbox, index) => {
                completionStatus[`completion${index+1}`] = checkbox.classList.contains('checked');
            });
            
            // Collect collapsible section states
            const sectionStates = {};
            document.querySelectorAll('.collapsible-header').forEach((header, index) => {
                sectionStates[`section${index+1}`] = header.classList.contains('active');
            });
            
            // Collect reflection responses
            const reflections = {};
            document.querySelectorAll('.reflection textarea').forEach((textarea, index) => {
                reflections[`reflection${index+1}`] = textarea.value;
            });
            
            // Collect notes
            const notes = JSON.parse(localStorage.getItem('session3Notes') || '{}');
            
            // Save to localStorage first (for offline access)
            const progressData = {
                completionStatus,
                sectionStates,
                reflections,
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem('session3Progress', JSON.stringify(progressData));
            
            // Try to save to cloud if user is logged in
            let cloudSuccess = false;
            if (window.saveProgressToCloud && localStorage.getItem("isLoggedIn") === "true") {
                const sessionData = {
                    session3Progress: progressData,
                    session3Notes: notes
                };
                cloudSuccess = await window.saveProgressToCloud(sessionData);
            }
            
            // Update sync status based on cloud save result
            setTimeout(() => {
                if (cloudSuccess) {
                    syncStatus.innerHTML = '<i class="fas fa-cloud"></i><span>Cloud Synced</span>';
                    syncStatus.className = 'sync-status synced';
                    showNotification('Progress saved to cloud', 'success');
                } else if (localStorage.getItem("isLoggedIn") === "true") {
                    syncStatus.innerHTML = '<i class="fas fa-laptop"></i><span>Local Only</span>';
                    syncStatus.className = 'sync-status local';
                    showNotification('Saved locally (offline)', 'warning');
                } else {
                    syncStatus.innerHTML = '<i class="fas fa-user-slash"></i><span>Local Only</span>';
                    syncStatus.className = 'sync-status offline';
                    showNotification('Not logged in - saving locally', 'warning');
                }
            }, 800);
        }

        // ENHANCED: Load Progress from Local Storage (cloud data loads automatically via auth-check.js)
        function loadProgress() {
            // Always try to load from localStorage first (fastest)
            const savedProgress = localStorage.getItem('session3Progress');
            const savedNotes = localStorage.getItem('session3Notes');
            
            if (savedProgress) {
                const progressData = JSON.parse(savedProgress);
                
                // Load completion status
                if (progressData.completionStatus) {
                    Object.keys(progressData.completionStatus).forEach(key => {
                        const checkbox = document.getElementById(key);
                        if (checkbox && progressData.completionStatus[key]) {
                            checkbox.classList.add('checked');
                        }
                    });
                }
                
                // Load section states
                if (progressData.sectionStates) {
                    // Close all sections first
                    document.querySelectorAll('.collapsible-header').forEach(h => {
                        h.classList.remove('active');
                    });
                    document.querySelectorAll('.collapsible-content').forEach(c => {
                        c.classList.remove('active');
                        c.style.maxHeight = null;
                    });
                    
                    // Open saved active sections
                    Object.keys(progressData.sectionStates).forEach(key => {
                        if (progressData.sectionStates[key]) {
                            const header = document.getElementById(key.replace('section', 'header'));
                            const content = document.getElementById(key.replace('section', 'content'));
                            if (header && content) {
                                header.classList.add('active');
                                content.classList.add('active');
                                content.style.maxHeight = content.scrollHeight + 'px';
                            }
                        }
                    });
                }
                
                // Load reflection responses
                if (progressData.reflections) {
                    Object.keys(progressData.reflections).forEach(key => {
                        const textarea = document.querySelector(`[data-reflection-id="${key.replace('reflection', '')}"]`);
                        if (textarea) {
                            textarea.value = progressData.reflections[key];
                        }
                    });
                }
                
                updateProgressBar();
            }
            
            // Load notes if they exist
            if (savedNotes) {
                const notesData = JSON.parse(savedNotes);
                Object.keys(notesData).forEach(noteId => {
                    const container = document.getElementById(`${noteId}-notes`);
                    if (container) {
                        loadNotes(noteId, container);
                    }
                });
            }
        }

        // Show Progress Summary
        function showProgressSummary() {
            const checkboxes = document.querySelectorAll('.completion-checkbox');
            const checked = document.querySelectorAll('.completion-checkbox.checked');
            const progress = Math.round((checked.length / checkboxes.length) * 100);
            
            // Count notes
            const notes = JSON.parse(localStorage.getItem('session3Notes') || '{}');
            let noteCount = 0;
            Object.keys(notes).forEach(key => {
                noteCount += notes[key].length;
            });
            
            const userStatus = localStorage.getItem("isLoggedIn") === "true" ? 
                `(Cloud Sync: ${localStorage.getItem("userEmail")})` : 
                "(Local Only - Not logged in)";
            
            alert(`Your progress: ${progress}% completed\n\n${checked.length} out of ${checkboxes.length} sections marked as complete.\n${noteCount} personal notes saved.\n\n${userStatus}`);
        }

        // NEW: Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '80px';
            notification.style.right = '20px';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = 'var(--radius)';
            notification.style.color = 'white';
            notification.style.fontWeight = '500';
            notification.style.zIndex = '9999';
            notification.style.boxShadow = 'var(--shadow)';
            notification.style.transition = 'transform 0.3s, opacity 0.3s';
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            
            if (type === 'success') {
                notification.style.background = 'var(--success)';
            } else if (type === 'error') {
                notification.style.background = 'var(--accent)';
            } else if (type === 'warning') {
                notification.style.background = 'var(--warning)';
            } else {
                notification.style.background = 'var(--secondary)';
            }
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 10);
            
            // Animate out after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Make loadProgress available globally for auth-check.js
        window.loadProgress = loadProgress;
    </script>
</body>
</html>