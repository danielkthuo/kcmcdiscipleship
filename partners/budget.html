<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Budget - KCMC Partners</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2ecc71"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="KCMC Partners">
    <meta name="description" content="KCMC Partners Church Budget">
    
    <!-- PWA Links -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    
    <style>
        :root {
            --primary: #2ecc71;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --gray: #6c757d;
            --radius: 12px;
            --shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.5;
            padding-bottom: 70px; /* Space for bottom nav */
            font-size: 14px;
        }

        .container {
            width: 100%;
            padding: 0 15px;
            max-width: 100%;
        }

        /* Header Styles */
        header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 10px 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .logo h1 {
            font-size: 1.0rem;
            color: var(--dark);
        }

        /* Mobile Navigation */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 99;
            padding: 8px 0;
            overflow-x: auto;
            white-space: nowrap;
        }

        nav ul {
            display: flex;
            justify-content: space-around;
            list-style: none;
            min-width: 100%;
        }

        nav ul li {
            display: inline-block;
        }

        nav ul li a {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 0.7rem;
            padding: 4px;
            border-radius: var(--radius);
            transition: all 0.3s;
            min-width: 55px;
        }

        nav ul li a i {
            font-size: 1rem;
            margin-bottom: 2px;
        }

        nav ul li a.active {
            color: var(--primary);
            background: rgba(46, 204, 113, 0.1);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-small {
            padding: 5px 8px;
            font-size: 0.75rem;
        }

        /* Main Content */
        main {
            padding: 12px 0;
        }

        .page-header {
            text-align: center;
            padding: 16px 15px;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .page-header h2 {
            font-size: 1.2rem;
            margin-bottom: 6px;
        }

        .page-header p {
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .card h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: var(--dark);
            font-size: 1rem;
        }

        .card-icon {
            color: var(--primary);
            font-size: 1rem;
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        .grid-2 {
            grid-template-columns: 1fr;
        }

        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .grid-4 {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Financial Cards */
        .financial-card {
            text-align: center;
            padding: 12px 8px;
            min-height: auto;
        }

        .financial-card h3 {
            font-size: 0.8rem;
            margin-bottom: 6px;
            justify-content: center;
        }

        .financial-card .amount {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 6px 0;
        }

        .financial-card .subtitle {
            color: var(--gray);
            font-size: 0.75rem;
        }

        /* Budget Allocation */
        .allocation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(46, 204, 113, 0.05);
            border-radius: var(--radius);
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
        }

        .allocation-item .percentage {
            font-weight: bold;
            font-size: 0.95rem;
            color: var(--dark);
        }

        /* Expense Table */
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .expense-table th {
            text-align: left;
            padding: 10px 8px;
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid #ddd;
            font-size: 0.8rem;
        }

        .expense-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
        }

        .expense-table tr:last-child td {
            border-bottom: none;
        }

        .amount-cell {
            text-align: right;
            font-weight: 600;
        }

        .percentage-cell {
            text-align: right;
            color: var(--gray);
        }

        /* Form Controls */
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 0.9rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Loading and Empty States */
        .loading {
            text-align: center;
            padding: 24px;
        }

        .loading i {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 12px;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 12px 16px;
            border-radius: var(--radius);
            color: white;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 260px;
            box-shadow: var(--shadow);
            animation: slideInRight 0.3s ease-out;
            font-size: 0.85rem;
        }

        .notification-success {
            background: var(--success);
        }

        .notification-error {
            background: var(--accent);
        }

        .notification-info {
            background: var(--secondary);
        }

        .notification button {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            margin-left: 12px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Chart Styles */
        .chart-container {
            height: 250px;
            margin: 16px 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding: 16px 0;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.2rem;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close {
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 1.2rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.85rem;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .grid-3 {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 12px;
            }
            
            .grid-4 {
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
            
            nav {
                position: static;
                background: none;
                box-shadow: none;
                padding: 0;
                overflow-x: visible;
                white-space: normal;
            }
            
            nav ul {
                justify-content: flex-start;
                gap: 16px;
            }
            
            nav ul li a {
                flex-direction: row;
                font-size: 0.9rem;
                padding: 6px 12px;
            }
            
            nav ul li a i {
                margin-bottom: 0;
                margin-right: 6px;
            }
            
            body {
                padding-bottom: 0;
            }
        }

        @media (max-width: 480px) {
            .page-header {
                padding: 12px 8px;
            }
            
            .card {
                padding: 12px;
            }
            
            .financial-card .amount {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .expense-table {
                font-size: 0.8rem;
            }
            
            .expense-table th, 
            .expense-table td {
                padding: 8px 5px;
            }
        }

        /* Number formatting */
        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--accent);
        }
        /*monthly distribution */
        /* Add to existing CSS */
        @media (max-width: 768px) {
            .monthly-table-container {
                overflow-x: auto;
                max-width: 100%;
            }
            
            #budgetTable {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Required Modal -->
    <div id="loginRequiredModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login Required</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 1rem;">
                    <i class="fas fa-lock" style="font-size: 2.5rem; color: var(--accent); margin-bottom: 0.8rem;"></i>
                    <h3 style="font-size: 1.1rem;">Partner Access Required</h3>
                    <p style="font-size: 0.85rem;">Budget and expense details are available exclusively to our ministry partners.</p>
                    <p style="font-size: 0.85rem;">Please log in to view financial transparency information.</p>
                    <div style="margin-top: 1.5rem; display: flex; gap: 8px; flex-direction: column;">
                        <button id="goToLoginBtn" class="btn">Log In Now</button>
                        <button id="goToHomeBtn" class="btn btn-secondary">Return Home</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Partner Login</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">
                        <span id="loginButtonText">Sign In</span>
                        <div id="loginSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
                <div id="loginMessage" style="margin-top: 12px; text-align: center;"></div>
                
             
            </div>
        </div>
    </div>

     <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">üïäÔ∏è</div>
                    <h1>BUDGET</h1>
                </div>
                <div class="user-actions">
                    <button id="loginBtn" class="btn btn-secondary btn-small">
                        <i class="fas fa-sign-in-alt"></i>
                    </button>

                    <!-- New My Givings Button -->
                    <button id="myGivingsBtn" class="btn btn-small" style="background: var(--secondary); color: #fff;">
                        <i class="fas fa-hand-holding-heart"></i>
                        <span class="desktop-text">My Givings</span>
                    </button>
                    <script>
                        document.getElementById('myGivingsBtn').addEventListener('click', () => {
                            window.location.href = 'contribution.html';
                        });
                    </script>
                    <div id="userMenu" style="display: none;">
                        <span id="userGreeting" style="margin-right: 8px; font-size: 0.8rem;"></span>
                        <button id="logoutBtn" class="btn btn-small">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    <div class="user-actions">
                    <button id="refreshData" class="btn btn-small">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                </div>
            </div>
        </div>
    </header>


    <!-- Main Content (Only visible when logged in) -->
    <main id="mainContent" style="display: none;">
        <div class="container">
            <section class="page-header">
                <h2>Church Budget Analysis</h2>
                <p>Multi-year budget tracking and visualization from Google Sheets</p>
            </section>

            <!-- Controls -->
            <section class="card">
                <div class="grid grid-2">
                    <div>
                        <label for="yearSelect" style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">Budget Year</label>
                        <select id="yearSelect" class="form-control">
                            <option value="">Select Year</option>
                            <option value="2025">2025 Budget</option>
                            <option value="2026">2026 Budget</option>
                            <option value="2027">2027 Budget</option>
                        </select>
                    </div>
                    <div>
                        <label for="viewSelect" style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">View Type</label>
                        <select id="viewSelect" class="form-control">
                            <option value="detailed">Detailed View</option>
                            <option value="summary">Summary View</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Summary Cards -->
            <section class="grid grid-4" id="summarySection" style="display: none;">
                <div class="card financial-card">
                    <h3 style="color: var(--primary);">Total Budget</h3>
                    <div class="amount" id="totalBudget">Ksh 0</div>
                    <div class="subtitle">Annual Budget</div>
                </div>
                <div class="card financial-card">
                    <h3 style="color: var(--secondary);">Actual Support</h3>
                    <div class="amount" id="actualSupport">Ksh 0</div>
                    <div class="subtitle">Support Received</div>
                </div>
                <div class="card financial-card">
                    <h3 style="color: var(--accent);">Variance</h3>
                    <div class="amount" id="varianceAmount">Ksh 0</div>
                    <div class="subtitle" id="varianceSubtitle">Difference</div>
                </div>
                <div class="card financial-card">
                    <h3 style="color: var(--warning);">Budget Period</h3>
                    <div class="amount" id="budgetPeriod">-</div>
                    <div class="subtitle">Fiscal Year</div>
                </div>
            </section>

            <!-- Quick Stats -->
            <section class="card">
                <h3><i class="fas fa-chart-bar card-icon"></i> Top Categories</h3>
                <div class="grid grid-2" id="categoryStats">
                    <!-- Dynamic stats will be inserted here -->
                </div>
            </section>

            <!-- Chart Section -->
            <section class="card">
                <h3><i class="fas fa-chart-pie card-icon"></i> Budget Distribution</h3>
                <div class="chart-container">
                    <canvas id="budgetChart"></canvas>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button id="toggleChart" class="btn btn-small">
                        <i class="fas fa-chart-bar"></i> Switch to Bar Chart
                    </button>
                </div>
            </section>

            <!-- Budget Table -->
            <section class="card">
                <h3><i class="fas fa-table card-icon"></i> Budget Details</h3>
                <div style="overflow-x: auto;">
                    <table class="expense-table" id="budgetTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Category</th>
                                <th style="text-align: right;">Budget</th>
                            </tr>
                        </thead>
                        <tbody id="budgetTableBody">
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 2rem;">
                                    <p>Select a budget year to view data</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button id="toggleMonthly" class="btn btn-small">
                        <i class="fas fa-calendar-alt"></i> Show Monthly Details
                    </button>
                    <button id="exportData" class="btn btn-small" style="background: var(--success);">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>
            </section>

            <!-- Last Updated -->
            <section class="card" style="background: #e8f6f3; border-left: 4px solid var(--primary);">
                <h3><i class="fas fa-info-circle card-icon"></i> Information</h3>
                <p style="font-size: 0.85rem; margin-bottom: 8px;">
                    Data is loaded directly from Google Sheets in real-time. The budget follows the church fiscal year from July to June.
                </p>
                <p style="font-size: 0.8rem; color: var(--gray);" id="lastUpdated">
                    Select a year to view budget
                </p>
            </section>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav>
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="activities.html"><i class="fas fa-tasks"></i> Activities</a></li>
            <li><a href="budget.html" class="active"><i class="fas fa-chart-pie"></i> Budget</a></li>
            <li><a href="contribution.html"><i class="fas fa-donate"></i> Contributions</a></li>
            <li><a href="updates.html"><i class="fas fa-newspaper"></i> Updates</a></li>
        </ul>
    </nav>

    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDfNX8WUWfUAN-dIUtzq8gJXjh0CIZdS_0",
            authDomain: "kcmcpartners.firebaseapp.com",
            projectId: "kcmcpartners",
            storageBucket: "kcmcpartners.firebasestorage.app",
            messagingSenderId: "30984885444",
            appId: "1:30984885444:web:0be4febff8cfef1b22a591",
            measurementId: "G-Z6FMF6Z1V1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Google Sheets configuration
        const SHEET_ID = '1uCdQXkF8sb_8PgU1C0NuuGg1sssRScHRP_mjRLznu9k';
        const API_KEY = 'AIzaSyCmFtniBYGJqy3BgEzxWDOhL7LfOns5LJk';
        
        // Map sheet names to years
        const sheetMap = {
            '2025': '2025',
            '2026': '2026', 
            '2027': '2027'
        };

        // Global variables
        let currentYear = null;
        let currentChartType = 'pie';
        let showMonthlyView = false;
        let budgetChart = null;
        let budgetData = {};
        let summaryData = {};

        // DOM Elements
        const loginRequiredModal = document.getElementById('loginRequiredModal');
        const loginModal = document.getElementById('loginModal');
        const mainContent = document.getElementById('mainContent');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userMenu = document.getElementById('userMenu');
        const userGreeting = document.getElementById('userGreeting');
        const goToLoginBtn = document.getElementById('goToLoginBtn');
        const goToHomeBtn = document.getElementById('goToHomeBtn');
        const closeBtns = document.querySelectorAll('.close');
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');
        const loginButtonText = document.getElementById('loginButtonText');
        const loginSpinner = document.getElementById('loginSpinner');

        const yearSelect = document.getElementById('yearSelect');
        const viewSelect = document.getElementById('viewSelect');
        const refreshDataBtn = document.getElementById('refreshData');
        const exportDataBtn = document.getElementById('exportData');
        const toggleChartBtn = document.getElementById('toggleChart');
        const toggleMonthlyBtn = document.getElementById('toggleMonthly');
        const budgetTableBody = document.getElementById('budgetTableBody');
        const lastUpdatedEl = document.getElementById('lastUpdated');
        const summarySection = document.getElementById('summarySection');
        const categoryStats = document.getElementById('categoryStats');
        const totalBudgetEl = document.getElementById('totalBudget');
        const actualSupportEl = document.getElementById('actualSupport');
        const varianceAmountEl = document.getElementById('varianceAmount');
        const varianceSubtitle = document.getElementById('varianceSubtitle');
        const budgetPeriodEl = document.getElementById('budgetPeriod');

        // Month names
        const monthNames = ['July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March', 'April', 'May', 'June'];

        // Authentication state management
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                await handleUserLogin(user);
                checkAuthAndLoadContent();
            } else {
                // No user signed in
                showLoginButton();
                checkAuthAndLoadContent();
            }
        });

        // Handle user login
        async function handleUserLogin(firebaseUser) {
            try {
                const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                let userData = { role: 'visitor', name: 'Guest' };
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                }

                const user = {
                    uid: firebaseUser.uid,
                    email: firebaseUser.email,
                    name: userData.name || firebaseUser.email.split('@')[0],
                    role: userData.role || 'visitor'
                };
                
                localStorage.setItem('currentUser', JSON.stringify(user));
                showUserMenu(user);
            } catch (error) {
                console.error('Error handling user login:', error);
            }
        }

        // Check authentication and load content
        function checkAuthAndLoadContent() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            
            if (user) {
                // User is logged in - show content
                mainContent.style.display = 'block';
                loginRequiredModal.style.display = 'none';
                showUserMenu(user);
                
                // Initialize budget functionality
                initializeBudgetApp();
                
            } else {
                // User is not logged in - show login required modal
                mainContent.style.display = 'none';
                loginRequiredModal.style.display = 'block';
                showLoginButton();
            }
        }

        // Show login button
        function showLoginButton() {
            loginBtn.style.display = 'block';
            userMenu.style.display = 'none';
        }

        // Show user menu when logged in
        function showUserMenu(user) {
            loginBtn.style.display = 'none';
            userMenu.style.display = 'flex';
            userGreeting.textContent = `Hi, ${user.name.split(' ')[0]}`;
        }

        // Logout function
        function logoutUser() {
            auth.signOut()
                .then(() => {
                    localStorage.removeItem('currentUser');
                    checkAuthAndLoadContent(); // This will show the login required modal
                    showNotification('You have been logged out successfully.', 'info');
                })
                .catch((error) => {
                    console.error('Logout error:', error);
                });
        }

        // Enhanced login function with Firebase Authentication
        async function loginUser(email, password) {
            // Show loading state
            loginButtonText.style.display = 'none';
            loginSpinner.style.display = 'inline-block';
            loginMessage.innerHTML = '';

            try {
                // Sign in with Firebase Authentication
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // handleUserLogin will be called automatically via onAuthStateChanged
                loginModal.style.display = 'none';
                loginForm.reset();
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Handle specific error cases
                let errorMessage = 'Login failed. Please try again.';
                
                if (error.code === 'auth/invalid-login-credentials') {
                    errorMessage = 'Invalid email or password. Please use the demo accounts or contact an administrator.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email. Please contact an administrator to create an account.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Please try again later.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection.';
                }
                
                loginMessage.innerHTML = `<div style="color: var(--accent); padding: 8px; background: #ffeaea; border-radius: var(--radius); font-size: 0.85rem;">${errorMessage}</div>`;
            } finally {
                // Reset loading state
                loginButtonText.style.display = 'inline';
                loginSpinner.style.display = 'none';
            }
        }

        // Initialize the budget application
        function initializeBudgetApp() {
            // Event listeners for budget functionality
            yearSelect.addEventListener('change', loadYearData);
            viewSelect.addEventListener('change', changeView);
            refreshDataBtn.addEventListener('click', refreshAllData);
            exportDataBtn.addEventListener('click', exportBudgetData);
            toggleChartBtn.addEventListener('click', toggleChartType);
            toggleMonthlyBtn.addEventListener('click', toggleMonthlyView);
        }

        // Load data for selected year
        async function loadYearData() {
            const selectedYear = yearSelect.value;
            if (!selectedYear) return;

            currentYear = selectedYear;
            
            showNotification(`Loading ${selectedYear} budget data...`, 'info');
            
            // Show loading state
            budgetTableBody.innerHTML = 
                '<tr><td colspan="3" style="text-align: center; padding: 2rem;"><p><i class="fas fa-spinner fa-spin"></i> Loading budget data...</p></td></tr>';
            
            try {
                await fetchBudgetData(selectedYear);
                displayBudgetData();
                updateSummary();
                updateCategoryStats();
                updateBudgetChart();
                
                showNotification(`Successfully loaded ${selectedYear} budget data`, 'success');
                lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()} (${selectedYear} Budget)`;
                
            } catch (error) {
                console.error('Error loading budget data:', error);
                showNotification(`Error loading budget data: ${error.message}`, 'error');
                budgetTableBody.innerHTML = 
                    '<tr><td colspan="3" style="text-align: center; padding: 2rem;"><p>Error loading budget data</p></td></tr>';
            }
        }

        // Fetch budget data from Google Sheets
        async function fetchBudgetData(year) {
            const sheetName = sheetMap[year];
            if (!sheetName) {
                throw new Error(`No sheet mapping found for year ${year}`);
            }

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}?key=${API_KEY}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.values || data.values.length === 0) {
                throw new Error('No data found in sheet');
            }
            
            processSheetData(year, data.values);
        }

        // Process raw sheet data into structured format
        function processSheetData(year, sheetData) {
            budgetData[year] = [];
            summaryData[year] = {
                totalBudget: 0,
                actualSupport: 0,
                variance: 0,
                period: `${year} Budget Year`
            };

            let calculatedTotal = 0;
            let foundTotalRow = false;
            
            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i];
                
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? row[0].toString().trim() : '';
                
                // Look for total budget row
                if (firstCell.toUpperCase().includes('TOTAL') && 
                    (firstCell.toUpperCase().includes('BUDGET') || firstCell.toUpperCase().includes('EXPENSE'))) {
                    if (row.length > 2 && row[2]) {
                        const totalValue = parseFloat(row[2].toString().replace(/,/g, ''));
                        if (!isNaN(totalValue)) {
                            summaryData[year].totalBudget = totalValue;
                            foundTotalRow = true;
                        }
                    }
                    continue;
                }
                
                // Look for actual support row
                if (firstCell.toUpperCase().includes('ACTUAL') && firstCell.toUpperCase().includes('SUPPORT')) {
                    if (row.length > 2 && row[2]) {
                        const actualValue = parseFloat(row[2].toString().replace(/,/g, ''));
                        if (!isNaN(actualValue)) {
                            summaryData[year].actualSupport = actualValue;
                        }
                    }
                    continue;
                }
                
                // Look for variance row
                if (firstCell.toUpperCase().includes('VARIANCE')) {
                    if (row.length > 2 && row[2]) {
                        const varianceValue = parseFloat(row[2].toString().replace(/,/g, ''));
                        if (!isNaN(varianceValue)) {
                            summaryData[year].variance = varianceValue;
                        }
                    }
                    continue;
                }
                
                // Process budget category rows (starting with E)
                if (firstCell.startsWith('E') && row.length >= 15) {
                    const code = firstCell;
                    const name = row[1] ? row[1].toString().trim() : '';
                    const total = parseFloat(row[2].toString().replace(/,/g, '')) || 0;
                    
                    calculatedTotal += total;
                    
                    const months = [];
                    for (let j = 3; j < 15; j++) {
                        let value = row[j];
                        if (value === undefined || value === null) {
                            months.push(0);
                            continue;
                        }
                        
                        value = value.toString().trim();
                        if (value === '-' || value === '' || value === '0') {
                            months.push(0);
                        } else {
                            const numValue = parseFloat(value.replace(/,/g, ''));
                            months.push(isNaN(numValue) ? 0 : numValue);
                        }
                    }

                    budgetData[year].push({
                        code,
                        name,
                        total,
                        months
                    });
                }
            }

            if (!foundTotalRow || summaryData[year].totalBudget === 0) {
                summaryData[year].totalBudget = calculatedTotal;
            }
            
            if (summaryData[year].variance === 0) {
                summaryData[year].variance = summaryData[year].actualSupport - summaryData[year].totalBudget;
            }
        }

        // Display budget data in the table
        function displayBudgetData() {
            const tableBody = document.getElementById('budgetTableBody');
            tableBody.innerHTML = '';
            
            const yearData = budgetData[currentYear];
            if (!yearData || yearData.length === 0) {
                tableBody.innerHTML = 
                    '<tr><td colspan="3" style="text-align: center; padding: 2rem;"><p>No budget data available for this year</p></td></tr>';
                return;
            }
            
            yearData.forEach(category => {
                const tableRow = document.createElement('tr');
                
                const formattedTotal = formatNumber(category.total);
                
                tableRow.innerHTML = `
                    <td><strong>${category.code}</strong></td>
                    <td>${category.name}</td>
                    <td class="amount-cell">Ksh ${formattedTotal}</td>
                `;
                
                tableBody.appendChild(tableRow);
            });
            
            summarySection.style.display = 'grid';
        }

        // Update summary information
        function updateSummary() {
            const summary = summaryData[currentYear];
            if (!summary) return;
            
            totalBudgetEl.textContent = `Ksh ${formatNumber(summary.totalBudget)}`;
            actualSupportEl.textContent = `Ksh ${formatNumber(summary.actualSupport)}`;
            
            const variance = summary.variance;
            varianceAmountEl.textContent = `Ksh ${formatNumber(Math.abs(variance))}`;
            
            if (variance >= 0) {
                varianceAmountEl.className = 'amount positive';
                varianceSubtitle.textContent = 'Surplus';
            } else {
                varianceAmountEl.className = 'amount negative';
                varianceSubtitle.textContent = 'Deficit';
            }
            
            budgetPeriodEl.textContent = summary.period;
        }

        // Update category statistics
        function updateCategoryStats() {
            const yearData = budgetData[currentYear];
            if (!yearData) return;
            
            const sortedCategories = [...yearData]
                .filter(cat => cat.total > 0)
                .sort((a, b) => b.total - a.total)
                .slice(0, 4);
            
            categoryStats.innerHTML = '';
            
            sortedCategories.forEach((category, index) => {
                // Define colors array directly in JavaScript
                const colors = ['#2ecc71', '#3498db', '#e74c3c', '#f39c12']; // primary, secondary, accent, warning
                const statCard = document.createElement('div');
                statCard.className = 'financial-card';
                statCard.style.borderLeft = `4px solid ${colors[index]}`;
                
                statCard.innerHTML = `
                    <h3 style="color: ${colors[index]};">${category.name}</h3>
                    <div class="amount">Ksh ${formatNumber(category.total)}</div>
                    <div class="subtitle">${category.code}</div>
                `;
                
                categoryStats.appendChild(statCard);
            });
        }

        // Update budget chart
        function updateBudgetChart() {
            const ctx = document.getElementById('budgetChart').getContext('2d');
            const yearData = budgetData[currentYear];
            
            if (!yearData) return;
            
            const chartData = yearData.filter(cat => cat.total > 0);
            
            const labels = chartData.map(cat => cat.name);
            const data = chartData.map(cat => cat.total);
            const backgroundColors = generateColors(chartData.length);
            
            if (budgetChart) {
                budgetChart.destroy();
            }
            
            budgetChart = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Budget Distribution - ${currentYear}`,
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            });
        }

        // Toggle chart type
        function toggleChartType() {
            currentChartType = currentChartType === 'pie' ? 'bar' : 'pie';
            updateBudgetChart();
            toggleChartBtn.innerHTML = currentChartType === 'pie' ? 
                '<i class="fas fa-chart-bar"></i> Switch to Bar Chart' : 
                '<i class="fas fa-chart-pie"></i> Switch to Pie Chart';
        }

        // Toggle monthly view
        function toggleMonthlyView() {
            showMonthlyView = !showMonthlyView;
            
            if (showMonthlyView) {
                displayMonthlyData();
                toggleMonthlyBtn.innerHTML = '<i class="fas fa-table"></i> Hide Monthly Details';
            } else {
                displayBudgetData();
                toggleMonthlyBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Show Monthly Details';
            }
        }

        // Display monthly data
        function displayMonthlyData() {
            const tableBody = document.getElementById('budgetTableBody');
            tableBody.innerHTML = '';
            
            const yearData = budgetData[currentYear];
            if (!yearData || yearData.length === 0) {
                tableBody.innerHTML = 
                    '<tr><td colspan="15" style="text-align: center; padding: 2rem;"><p>No budget data available for this year</p></td></tr>';
                return;
            }
            
            // Update table headers for monthly view
            const tableHead = document.querySelector('#budgetTable thead tr');
            tableHead.innerHTML = `
                <th>Code</th>
                <th>Category</th>
                ${monthNames.map(month => `<th style="text-align: right;">${month}</th>`).join('')}
                <th style="text-align: right;">Total</th>
            `;
            
            // Add monthly data rows
            yearData.forEach(category => {
                const tableRow = document.createElement('tr');
                
                const monthlyCells = category.months.map(amount => 
                    `<td class="amount-cell">${amount > 0 ? '' + formatNumber(amount) : '-'}</td>`
                ).join('');
                
                tableRow.innerHTML = `
                    <td><strong>${category.code}</strong></td>
                    <td>${category.name}</td>
                    ${monthlyCells}
                    <td class="amount-cell">Ksh ${formatNumber(category.total)}</td>
                `;
                
                tableBody.appendChild(tableRow);
            });
            
            // Add monthly totals row
            const monthlyTotals = calculateMonthlyTotals(yearData);
            const totalsRow = document.createElement('tr');
            totalsRow.style.fontWeight = 'bold';
            totalsRow.style.backgroundColor = '#f8f9fa';
            
            const monthlyTotalCells = monthlyTotals.map(total => 
                `<td class="amount-cell">Ksh ${formatNumber(total)}</td>`
            ).join('');
            
            totalsRow.innerHTML = `
                <td colspan="2"><strong>Monthly Totals</strong></td>
                ${monthlyTotalCells}
                <td class="amount-cell">Ksh ${formatNumber(yearData.reduce((sum, cat) => sum + cat.total, 0))}</td>
            `;
            
            tableBody.appendChild(totalsRow);
        }

        // Calculate monthly totals
        function calculateMonthlyTotals(yearData) {
            const monthlyTotals = Array(12).fill(0);
            
            yearData.forEach(category => {
                category.months.forEach((amount, index) => {
                    monthlyTotals[index] += amount;
                });
            });
            
            return monthlyTotals;
        }

        // Change view type
        function changeView() {
            if (currentYear) {
                loadYearData();
            }
        }

        // Refresh all data
        function refreshAllData() {
            if (currentYear) {
                delete budgetData[currentYear];
                delete summaryData[currentYear];
                loadYearData();
            } else {
                showNotification('Please select a budget year first', 'error');
            }
        }

        // Export budget data
        function exportBudgetData() {
            if (!currentYear) {
                showNotification('Please select a budget year first', 'error');
                return;
            }
            
            try {
                const yearData = budgetData[currentYear];
                const summary = summaryData[currentYear];
                
                if (!yearData) {
                    throw new Error('No data available to export');
                }
                
                const headers = ['Code', 'Category', 'Total Budget'];
                const rows = yearData.map(cat => [
                    cat.code,
                    `"${cat.name}"`,
                    cat.total
                ]);
                
                rows.push(['', 'TOTAL ANNUAL BUDGET', summary.totalBudget]);
                rows.push(['', 'ACTUAL SUPPORT RECEIVED', summary.actualSupport]);
                rows.push(['', 'VARIANCE', summary.variance]);
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `kcmc-budget-${currentYear}-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`Budget data for ${currentYear} exported successfully`, 'success');
                
            } catch (error) {
                console.error('Error exporting budget data:', error);
                showNotification(`Error exporting budget data: ${error.message}`, 'error');
            }
        }

        // Show notification
        function showNotification(message, type) {
            document.querySelectorAll('.notification').forEach(notification => {
                notification.remove();
            });

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Helper function to format numbers with commas
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        // Helper function to generate colors for charts
        function generateColors(count) {
            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#34495e', '#d35400', '#c0392b', '#16a085'
            ];
            
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            
            return result;
        }

        // Event Listeners
        loginBtn.addEventListener('click', () => {
            loginModal.style.display = 'block';
        });

        logoutBtn.addEventListener('click', logoutUser);

        goToLoginBtn.addEventListener('click', () => {
            loginRequiredModal.style.display = 'none';
            loginModal.style.display = 'block';
        });

        goToHomeBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Close modal when clicking X or outside
        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                loginRequiredModal.style.display = 'none';
                loginModal.style.display = 'none';
                loginMessage.innerHTML = '';
                loginForm.reset();
            });
        });

        window.addEventListener('click', (e) => {
            if (e.target === loginRequiredModal || e.target === loginModal) {
                loginRequiredModal.style.display = 'none';
                loginModal.style.display = 'none';
                loginMessage.innerHTML = '';
                loginForm.reset();
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                loginMessage.innerHTML = '<div style="color: var(--accent); padding: 8px; background: #ffeaea; border-radius: var(--radius); font-size: 0.85rem;">Please fill in all fields.</div>';
                return;
            }

            loginUser(email, password);
        });

        // Check auth state on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already authenticated
            const currentUser = auth.currentUser;
            if (currentUser) {
                checkAuthAndLoadContent();
            }
        });
    </script>
</body>
</html>